(function() {
    const fixedGreenYOffset = 0.1;  // fix green's vertical offset once
    const greenY = 3.25 + fixedGreenYOffset;

    drawPlot = function() {
        const Y_orange = parseFloat(document.getElementById("Y_orange").value);
        const Y_green = parseFloat(document.getElementById("Y_green").value);
        const Y_row = parseFloat(document.getElementById("Y_row").value);
        const orange_x = parseFloat(document.getElementById("orange_x").value);
        const green_x = parseFloat(document.getElementById("green_x").value);
        const row_x = parseFloat(document.getElementById("row_x").value);
        const sigma = parseFloat(document.getElementById("sigmaSlider").value);
        const tauMult = parseFloat(document.getElementById("tauMultSlider").value);
        const asym = parseFloat(document.getElementById("asymSlider").value);
        const dispersion = parseFloat(document.getElementById("dispersionSlider").value);

        const Y_k = Y_row * 0.25;
        const Y_l = Y_row * 0.25;
        const Y_m = Y_row * 0.25;
        const Y_n = Y_row * 0.25;
        const Y_i = [Y_orange, Y_green, Y_k, Y_l, Y_m, Y_n];
        const N = Y_i.length;
        const pos_orange = [orange_x, 3.25];
        const pos_green = [green_x, greenY];
        const row_positions = generateRowPositions(row_x, dispersion);
        const positions = [pos_orange, pos_green, ...row_positions];

        const tau = Array.from({length: N}, (_, i) =>
            Array.from({length: N}, (_, j) => {
                if (i === j) return 1;
                const dx = positions[j][0] - positions[i][0];
                const dy = positions[j][1] - positions[i][1];
                const d = Math.hypot(dx, dy);
                const direction = Math.sign(dx);
                const asym_factor = Math.max(0.5, 1 + asym * direction / 2);
                return (1 + d * tauMult / 4) * asym_factor;
            })
        );

        const { flows } = computeFlows(Y_i, tau, sigma);

        const labels = ['o', 'g', 'a', 'b', 'c', 'd'];
        const nodes = labels.map((l, i) => ({
            type: 'scatter',
            mode: 'markers+text',
            x: [positions[i][0]],
            y: [positions[i][1]],
            marker: { size: 10 + Math.sqrt(Y_i[i]) * 2, color: i === 0 ? 'orange' : i === 1 ? 'lightgreen' : 'skyblue' },
            text: [l],
            textposition: 'top center',
            showlegend: false
        }));

        const arrows = [];
        for (let i = 0; i < N; i++) {
            for (let j = 0; j < N; j++) {
                if (i !== j && flows[i][j] > 0.5) {
                    arrows.push({
                        type: 'line',
                        x0: positions[i][0], y0: positions[i][1],
                        x1: positions[j][0], y1: positions[j][1],
                        line: {
                            width: Math.min(3, flows[i][j] / 5),
                            color: 'gray',
                            opacity: Math.min(1, flows[i][j] / 300)
                        }
                    });
                }
            }
        }

        const layout = {
            title: `Gravity Model (σ=${sigma}, τ=${tauMult}, Asym=${asym})`,
            xaxis: { range: [0, 12], visible: false },
            yaxis: { range: [0, 6.5], visible: false },
            shapes: arrows,
            width: 900,
            height: 500
        };

        Plotly.newPlot('plot', nodes, layout);
    };

    Array.from(document.querySelectorAll("input[type=range]")).forEach(el => {
        el.addEventListener("input", drawPlot);
    });

    drawPlot();
})();
